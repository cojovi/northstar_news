# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

The Northstar Ledger is a file-based news publication built with React, TypeScript, and Vite. It's a static site that uses markdown files for content management, with no database required.

## Development Commands

```bash
# Install dependencies
npm install

# Start development server (runs on http://localhost:5173)
# Automatically generates sitemap before starting
npm run dev

# Build for production
# Automatically generates sitemap before building
npm run build

# Preview production build
npm run preview

# Type checking (use this before committing)
npm run typecheck

# Lint code
npm run lint

# Generate sitemap manually
npm run sitemap
```

## Environment Setup

The site uses environment variables for optional features. Create a `.env` file in the root directory:

```bash
# Supabase (optional - for newsletter subscriptions)
VITE_SUPABASE_URL=your-supabase-url
VITE_SUPABASE_ANON_KEY=your-supabase-anon-key
```

**Note**: The site works without these variables. Newsletter subscription will be disabled if Supabase credentials are not configured (src/lib/supabase.ts:6-8).

## Architecture

### Project Structure

```
/content/                    # Markdown articles organized by category
  /{category}/*.md          # Article files with YAML front matter
  create_article.py         # Automated article generation script
  generate_article_image.py # Image generation for articles

/src/
  /components/              # React components
    Header.tsx             # Site header with navigation
    Footer.tsx             # Site footer
    HomePage.tsx           # Home page layout
    ArticlePage.tsx        # Individual article view
    CategoryPage.tsx       # Category listing page
    SearchPage.tsx         # Search interface
    ArticleCard.tsx        # Reusable article preview card

  /lib/                     # Core utilities
    content.ts             # Article loading, caching, search
    feeds.ts               # RSS/Atom types (optional; feeds generated by sitemap script)
    ThemeContext.tsx       # Dark mode context provider
    supabase.ts            # Supabase client for newsletter

  /types/                   # TypeScript definitions
    article.ts             # Article and front matter types

  App.tsx                   # Main app with custom router
  main.tsx                  # Vite entry point

/public/                    # Static assets
  /images/                  # Local images (optional)
  sitemap.xml               # Auto-generated sitemap index
  rss.xml                   # Auto-generated RSS feed
  atom.xml                  # Auto-generated Atom feed

/scripts/
  generate-sitemap.js       # Sitemap and RSS/Atom feed generation script
```

### Content Management System

The site uses a **file-based content system** where articles are stored as markdown files with YAML front matter:

- **Content location**: `/content/{category}/{slug}.md`
- **Content loading**: Uses Vite's `import.meta.glob` to eagerly load all markdown files at build time (src/lib/content.ts:37-41)
- **Parsing**: Custom markdown parser extracts front matter and body (src/lib/content.ts:6-35)
- **Caching**: Articles are cached in memory after first load (src/lib/content.ts:3-4)
- **Filtering**: Only articles with `status: published` are included (src/lib/content.ts:55)

### Routing System

Custom client-side routing implemented in `src/App.tsx` without external libraries like React Router:

- **Route parsing**: Path-based routing with URL patterns like `/{category}/{slug}` (src/App.tsx:17-43)
- **Navigation**: Intercepts all anchor clicks for same-origin links to prevent full page reloads (src/App.tsx:68-85)
- **History management**: Patches `window.history.pushState` to trigger React state updates on navigation (src/App.tsx:55-60)
- **Routes**:
  - `/` - Home page
  - `/{category}` - Category listing page
  - `/{category}/{slug}` - Individual article page
  - `/search` - Search page
  - `/about` - About page
- **SPA behavior**: All navigation is client-side; no page reloads after initial load

### Content API

The content library (src/lib/content.ts) provides these key functions:

- `getAllArticles()` - Returns all published articles, sorted by date (newest first)
- `getArticleBySlug(category, slug)` - Retrieves specific article with caching
- `getArticlesByCategory(category, limit?)` - Filters articles by category
- `searchArticles(query)` - Full-text search across title, dek, excerpt, tags, and content
- `getRelatedArticles(article, limit)` - Finds related articles based on category, tags, and author
- `getTrendingArticles(limit)` - Returns articles published in last 2 days

### Sitemap and Feed Generation

Automatic sitemap and RSS/Atom feed generation is triggered before development and production builds:

- **Script**: `scripts/generate-sitemap.js`
- **Sitemap output**: `public/sitemap.xml` (index), `post-sitemap.xml`, `section-sitemap.xml`, `page-sitemap.xml`
- **Feed output**: `public/rss.xml` (RSS 2.0), `public/atom.xml` (Atom). Each contains the latest 50 articles.
- **Includes**: Homepage, category pages, and all published articles
- **Priority**: Dynamic priority based on article age (1.0 for <7 days, 0.8 for <30 days, etc.)
- **Feed discovery**: `<link rel="alternate">` for RSS and Atom in `index.html`; "RSS Feed" link in footer (Footer.tsx).

### Theme System

Dark mode support via `src/lib/ThemeContext.tsx`:

- Uses React Context for theme state
- Persists preference to localStorage
- Applies `dark` class to document root
- Tailwind configured with `darkMode: 'class'`

### Styling

- **Framework**: Tailwind CSS with dark mode support
- **Fonts**: Lora (serif) for headlines, Inter (sans-serif) for body text
- **Custom colors**: `aurora` (teal accent) and `dark` (dark mode grays)
- **Config**: `tailwind.config.js`

### Newsletter Subscription

Optional newsletter feature using Supabase:

- **Implementation**: src/lib/supabase.ts creates Supabase client
- **Requirements**: Needs `VITE_SUPABASE_URL` and `VITE_SUPABASE_ANON_KEY` environment variables
- **Graceful degradation**: App works without Supabase; subscription feature simply won't be available
- **Database table**: Expects a table to store email subscriptions (table structure not specified in code)

## Article Front Matter Schema

Every article requires these fields:

```yaml
title: string          # Main headline
dek: string           # Subheading/summary
slug: string          # URL-friendly identifier
category: string      # Category name (us, world, politics, business, tech, health, entertainment, sports, opinion, lifestyle, travel)
tags: string[]        # Array of tags
author: string        # Author name
author_slug: string   # URL-friendly author identifier
published: string     # ISO 8601 datetime
updated: string       # ISO 8601 datetime
hero_image: string    # URL to large image
hero_credit: string   # Photo credit
thumbnail: string     # URL to thumbnail
excerpt: string       # Brief description for listings
reading_time: number  # Minutes to read
location?: string     # Optional location
status: 'draft' | 'published'
is_satire: boolean
canonical_url?: string # Optional
```

## Automated Article Creation

The repository includes an autonomous article creation tool:

### Article Creator Script (`content/create_article.py`)

**Purpose**: Fully automated blog post generation with integrated image creation.

**Features**:
- Generates 1200-1750 word articles from ideas, URLs, or unstructured text
- Analyzes existing articles to match publication tone and style
- Auto-generates all metadata (category, tags, location, author, etc.)
- Creates photorealistic hero images using DALL-E 3
- Produces complete markdown files ready for publication
- No manual intervention required

**Usage**:
```bash
cd content
export OPENAI_API_KEY='your-key'
python3 create_article.py
# Then paste: idea, URL, or text, press Ctrl+D
```

**Input Types**:
1. **Simple idea**: "Rise of AI in healthcare"
2. **URL to rewrite**: "https://example.com/article"
3. **Unstructured text**: Any notes or text blurbs

**What it generates**:
- Random author name and slug
- Appropriate category (auto-detected)
- 3-5 relevant tags
- Geographic location (if applicable)
- Compelling headline and subheading (dek)
- 1200-1750 word article body
- Photorealistic hero image
- Complete markdown with proper front matter

**Configuration**:
- Always sets `status: published`
- Always sets `is_satire: false`
- Prompts for optional custom tone (defaults to analyzed tone)
- Randomizes author from name pools in script

See `content/ARTICLE_CREATOR_README.md` for detailed documentation.

### Image Generation Script (`content/generate_article_image.py`)

**Purpose**: Generate hero images for existing articles (now integrated into `create_article.py`).

**Standalone usage** (if needed):
```bash
cd content
python3 generate_article_image.py path/to/article.md
```

This reads the article, generates an appropriate photorealistic image, saves it to `public/`, and updates the markdown file's `hero_image` and `thumbnail` fields.

## Key Implementation Details

### Adding New Articles

**Option 1: Automated (Recommended)**
```bash
cd content
python3 create_article.py
# Provide idea/URL/text, done!
```

**Option 2: Manual**
1. Create markdown file in `/content/{category}/{slug}.md`
2. Add required front matter with `status: published`
3. Write content in markdown below front matter
4. Sitemap auto-regenerates on next `npm run dev` or `npm run build`

### Content Loading Flow

**At build time:**
1. Vite's `import.meta.glob` eagerly loads all markdown files as raw strings (src/lib/content.ts:37-41)
2. Files are bundled into the final JavaScript build

**At runtime:**
1. `loadAllArticles()` is called on first content access
2. `parseMarkdown()` extracts front matter and body using regex
3. Articles filtered to only include `status: published`
4. Sorted by publication date (newest first)
5. Result cached in `allArticles` variable for subsequent requests
6. Individual articles cached in `articleCache` Map by `{category}/{slug}` key

**Important**: Content is static after build. To add/update articles in production, you must rebuild and redeploy.

### Search Implementation

Full-text search is implemented in-memory:
- Searches across: title, dek, excerpt, tags, content
- Case-insensitive matching
- No external search index required

### Related Articles Algorithm

Scoring system (src/lib/content.ts:136-153):
- Same category: +3 points
- Shared tag: +2 points per tag
- Same author: +1 point
- Returns top 4 articles by score

## Category Structure

Articles organized in these categories:
- `us` - U.S. News
- `world` - World News
- `politics` - Politics
- `business` - Business
- `tech` - Technology
- `health` - Health
- `entertainment` - Entertainment
- `sports` - Sports
- `opinion` - Opinion
- `lifestyle` - Lifestyle
- `travel` - Travel

## SEO Features

- NewsArticle schema.org structured data on article pages
- Open Graph and Twitter Card meta tags
- Semantic HTML with proper heading hierarchy
- Automatic sitemap generation at `/sitemap.xml`
- RSS and Atom feeds generated by the sitemap script and exposed at `/rss.xml` and `/atom.xml`; feed discovery in `index.html` and footer link in Footer.tsx

## Type Definitions

Core types in `src/types/article.ts`:
- `ArticleFrontMatter` - Front matter fields
- `Article` - Front matter + content + categoryPath
- `AuthorInfo`, `LiveUpdate`, `VideoItem`, `PhotoEssay` - Additional types for future features

## Design Philosophy

The site maintains a professional news aesthetic:
- Serif headlines for credibility
- Clean typography and generous spacing
- Responsive design for all screen sizes
- Accessible navigation with keyboard support
- Professional presentation for satire content (not immediately obvious)

## Deployment Considerations

### Static Site Hosting

This is a fully static site (SPA) that can be deployed to any static host:
- Netlify, Vercel, Cloudflare Pages (recommended - zero config)
- GitHub Pages, AWS S3 + CloudFront
- Any web server (Apache, Nginx, etc.)

### Server Configuration

For proper client-side routing, configure your host to:
1. Serve `index.html` for all routes (SPA fallback)
2. This ensures `/category/slug` URLs work when accessed directly

**Example Netlify `_redirects` file:**
```
/*    /index.html   200
```

**Example Vercel `vercel.json`:**
```json
{
  "rewrites": [{ "source": "/(.*)", "destination": "/index.html" }]
}
```

### Build Output

- Output directory: `/dist`
- All content is bundled at build time
- No server-side rendering or API required
- Sitemap generated to `/public/sitemap.xml` before build
